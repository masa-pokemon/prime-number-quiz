<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>素因数分解早押し</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .card {
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .input-box {
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 0.75rem;
            width: 100%;
            transition: border-color 0.3s;
        }

        .input-box:focus {
            outline: none;
            border-color: #6366f1;
        }

        .btn {
            background-color: #6366f1;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.2s;
        }

        .btn:hover {
            background-color: #4f46e5;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .hidden {
            display: none !important;
        }
        
        .timer-bar {
            background-color: #e5e7eb;
            height: 1rem;
            border-radius: 0.5rem;
            overflow: hidden;
            margin-top: 1rem;
        }

        .timer-fill {
            background-color: #3b82f6;
            height: 100%;
            width: 100%;
            transition: width 0.1s linear;
        }
        
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            z-index: 100;
            text-align: center;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <!-- Firestore CDN -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, addDoc, getDocs, runTransaction, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (provided by the user, with databaseURL fixed)
        const firebaseConfig = {
            apiKey: "AIzaSyCRn3SFElXUWjxQjYp4zeuo_T2cTeuBQGo",
            authDomain: "masa-chat-sechack365-2024.firebaseapp.com",
            databaseURL: "https://masa-chat-sechack365-2024-default-rtdb.firebaseio.com",
            projectId: "masa-chat-sechack365-2024",
            storageBucket: "masa-chat-sechack365-2024.firebasestorage.app",
            messagingSenderId: "1044636784507",
            appId: "1:1044636784507:web:11e4d87a209d7ca56dcfde",
            measurementId: "G-N8QNKPPR86"
        };
        
        // Canvas-provided global variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfigFromCanvas = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId;
        let userDocRef;
        let roomDocRef;
        let unsubscribeRoom;

        // Message box UI
        const showMessage = (message, title = "お知らせ") => {
            const container = document.getElementById('message-container');
            container.innerHTML = `
                <div class="message-box">
                    <h3 class="text-xl font-bold mb-4">${title}</h3>
                    <p>${message}</p>
                    <button id="close-message-btn" class="mt-4 btn">OK</button>
                </div>
            `;
            container.classList.remove('hidden');
            document.getElementById('close-message-btn').onclick = () => container.classList.add('hidden');
        };

        // Firebase Initialization and Authentication
        const setupFirebase = async () => {
            try {
                // Use canvas-provided config if available, otherwise use default
                const configToUse = Object.keys(firebaseConfigFromCanvas).length > 0 ? firebaseConfigFromCanvas : firebaseConfig;
                app = initializeApp(configToUse);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userDocRef = doc(db, `artifacts/${appId}/users/${userId}/private`, 'profile');
                        await checkAndCreateUser();
                        document.getElementById('loading-screen').classList.add('hidden');
                        showLoginScreen();
                    } else {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase setup error:", error);
                showMessage("Firebaseの初期化に失敗しました。インターネット接続を確認してください。", "エラー");
            }
        };

        const checkAndCreateUser = async () => {
            const docSnap = await getDoc(userDocRef);
            if (!docSnap.exists()) {
                await setDoc(userDocRef, {
                    username: '',
                    rating: 1000,
                    createdAt: serverTimestamp()
                });
            } else {
                const userData = docSnap.data();
                if (userData.username) {
                    document.getElementById('username-display').innerText = `ユーザー名: ${userData.username}`;
                    document.getElementById('rating-display').innerText = `レート: ${userData.rating}`;
                }
            }
        };

        const setUsername = async (username) => {
            if (!username) {
                showMessage("ユーザー名を入力してください。", "エラー");
                return;
            }
            try {
                await updateDoc(userDocRef, { username: username });
                document.getElementById('username-display').innerText = `ユーザー名: ${username}`;
                document.getElementById('name-input-screen').classList.add('hidden');
                showMainScreen();
            } catch (e) {
                console.error("Error setting username:", e);
                showMessage("ユーザー名の設定に失敗しました。", "エラー");
            }
        };
        
        // Screen Navigation
        const showScreen = (screenId) => {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        };
        const showLoginScreen = () => showScreen('name-input-screen');
        const showMainScreen = () => showScreen('main-menu-screen');
        const showOnlineMenu = () => showScreen('online-menu-screen');
        const showRoomLobby = () => showScreen('room-lobby-screen');
        const showGameScreen = () => showScreen('game-screen');
        
        // Game Logic
        let gameData = {};
        let timerInterval;
        let timer = 30; // 30 seconds per question
        const primes = [2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37, 41, 43, 47, 53, 59, 61, 67, 71, 73, 79, 83, 89, 97];

        const generateNumber = (difficulty) => {
            let n = 1;
            let factors = [];
            let numPrimes = 0;
            if (difficulty === 'easy') {
                numPrimes = Math.floor(Math.random() * 2) + 2; // 2 or 3 primes
            } else if (difficulty === 'normal') {
                numPrimes = Math.floor(Math.random() * 2) + 3; // 3 or 4 primes
            } else { // hard
                numPrimes = Math.floor(Math.random() * 3) + 4; // 4 to 6 primes
            }
            
            for (let i = 0; i < numPrimes; i++) {
                const primeIndex = Math.floor(Math.random() * primes.length);
                n *= primes[primeIndex];
                factors.push(primes[primeIndex]);
            }
            factors.sort((a, b) => a - b);
            return { number: n, factors: factors };
        };

        const isCorrectAnswer = (userAnswer, correctFactors) => {
            try {
                const sortedUserFactors = userAnswer.split('*').map(Number).sort((a, b) => a - b);
                if (sortedUserFactors.length !== correctFactors.length) return false;
                for (let i = 0; i < sortedUserFactors.length; i++) {
                    if (sortedUserFactors[i] !== correctFactors[i]) return false;
                }
                return true;
            } catch {
                return false;
            }
        };
        
        const startGame = (mode, difficulty = 'normal', roomId = null) => {
            showGameScreen();
            const { number, factors } = generateNumber(difficulty);
            gameData = { number, factors, startTime: Date.now(), mode, roomId };
            document.getElementById('question-number').innerText = number;
            document.getElementById('result-message').innerText = '';
            document.getElementById('answer-input').value = '';
            document.getElementById('game-area').classList.remove('hidden');
            document.getElementById('leaderboard-area').classList.add('hidden');
            
            timer = 30;
            updateTimerBar();
            timerInterval = setInterval(() => {
                timer--;
                updateTimerBar();
                if (timer <= 0) {
                    clearInterval(timerInterval);
                    endGame(false, '時間切れ');
                }
            }, 1000);
            
            if (mode === 'online' && gameData.roomId) {
                // Online game logic
                const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameData.roomId);
                onSnapshot(gameRef, (docSnap) => {
                    const roomData = docSnap.data();
                    if (!roomData) return;
                    
                    const leaderboardHtml = roomData.players.map(p => `
                        <li class="flex justify-between items-center p-2 rounded-lg ${p.userId === userId ? 'bg-indigo-100' : ''}">
                            <span>${p.username}</span>
                            <span>${p.score}</span>
                        </li>
                    `).join('');
                    document.getElementById('leaderboard-list').innerHTML = leaderboardHtml;

                    if (roomData.state === 'finished' && roomData.winnerId) {
                         clearInterval(timerInterval);
                         endGame(false, 'ゲーム終了');
                         if (roomData.winnerId === userId) {
                             showMessage("おめでとうございます！あなたが勝ちました！", "ゲーム終了");
                         } else {
                             const winner = roomData.players.find(p => p.userId === roomData.winnerId);
                             showMessage(`${winner.username}が勝ちました。`, "ゲーム終了");
                         }
                    } else if (roomData.questionNumber !== gameData.number) {
                        // Sync new question from host
                        gameData.number = roomData.questionNumber;
                        gameData.factors = []; // Factors are not shared directly
                        document.getElementById('question-number').innerText = roomData.questionNumber;
                        document.getElementById('answer-input').value = '';
                        timer = 30;
                        updateTimerBar();
                    }
                });
            }
        };

        const updateTimerBar = () => {
            const fill = document.getElementById('timer-fill');
            const percentage = (timer / 30) * 100;
            fill.style.width = `${percentage}%`;
        };

        const endGame = (isCorrect, message) => {
            clearInterval(timerInterval);
            document.getElementById('game-area').classList.add('hidden');
            document.getElementById('leaderboard-area').classList.remove('hidden');
            document.getElementById('final-message').innerText = message;
            
            if (isCorrect && gameData.mode === 'online') {
                submitOnlineAnswer(true);
            }
        };
        
        const submitAnswer = async () => {
            const userAnswer = document.getElementById('answer-input').value.trim();
            const isCorrect = isCorrectAnswer(userAnswer, gameData.factors);
            
            if (isCorrect) {
                const timeTaken = (Date.now() - gameData.startTime) / 1000;
                let score = Math.max(0, 100 - Math.floor(timeTaken * 2));
                
                if (gameData.mode === 'online') {
                    submitOnlineAnswer(score);
                } else {
                    document.getElementById('result-message').innerText = `正解です！スコア: ${score}`;
                    endGame(true, `正解です！タイム: ${timeTaken.toFixed(2)}秒 スコア: ${score}`);
                }
            } else {
                if (gameData.mode === 'offline') {
                    document.getElementById('result-message').innerText = `不正解です。正解は ${gameData.factors.join('*')}`;
                }
                endGame(false, `不正解です。もう一度チャレンジ！`);
            }
        };
        
        const submitOnlineAnswer = async (score) => {
            if (!gameData.roomId) return;
            const gameRef = doc(db, `artifacts/${appId}/public/data/games`, gameData.roomId);
            
            try {
                await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(gameRef);
                    if (!roomDoc.exists()) {
                        throw "Room does not exist!";
                    }
                    
                    const roomData = roomDoc.data();
                    const playerIndex = roomData.players.findIndex(p => p.userId === userId);
                    if (playerIndex > -1) {
                        const newPlayers = [...roomData.players];
                        newPlayers[playerIndex].score = score;
                        newPlayers[playerIndex].isFinished = true;
                        
                        // Check if all players have finished
                        const allFinished = newPlayers.every(p => p.isFinished);
                        if (allFinished) {
                            const winner = newPlayers.sort((a,b) => b.score - a.score)[0];
                            transaction.update(gameRef, { players: newPlayers, state: 'finished', winnerId: winner.userId });
                            await updateRating(winner.userId);
                        } else {
                            transaction.update(gameRef, { players: newPlayers });
                        }
                    }
                });
            } catch (e) {
                console.error("Transaction failed: ", e);
                showMessage("回答の送信に失敗しました。", "エラー");
            }
        };
        
        const updateRating = async (winnerId) => {
             const userRef = doc(db, `artifacts/${appId}/users/${userId}/private`, 'profile');
             const winnerRef = doc(db, `artifacts/${appId}/users/${winnerId}/private`, 'profile');
             
             try {
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    const winnerDoc = await transaction.get(winnerRef);
                    if (!userDoc.exists() || !winnerDoc.exists()) {
                         throw "User profile not found.";
                    }
                    const userData = userDoc.data();
                    const winnerData = winnerDoc.data();
                    
                    // Simple ELO-like rating update
                    const k = 32;
                    const expectedScoreUser = 1 / (1 + Math.pow(10, (winnerData.rating - userData.rating) / 400));
                    const expectedScoreWinner = 1 / (1 + Math.pow(10, (userData.rating - winnerData.rating) / 400));
                    
                    const newRatingUser = userData.rating + k * (0 - expectedScoreUser);
                    const newRatingWinner = winnerData.rating + k * (1 - expectedScoreWinner);
                    
                    transaction.update(userRef, { rating: Math.round(newRatingUser) });
                    transaction.update(winnerRef, { rating: Math.round(newRatingWinner) });
                });
                
            } catch (e) {
                console.error("Rating update failed: ", e);
            }
        };

        // Room Management
        const createRoom = async () => {
            const userProfile = (await getDoc(userDocRef)).data();
            if (!userProfile || !userProfile.username) {
                showMessage("ルームを作成するにはユーザー名が必要です。", "エラー");
                return;
            }
            const roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
            try {
                await setDoc(doc(db, `artifacts/${appId}/public/data/rooms`, roomId), {
                    hostId: userId,
                    players: [
                        { userId: userId, username: userProfile.username, score: 0 }
                    ],
                    state: 'waiting',
                    createdAt: serverTimestamp()
                });
                joinRoom(roomId);
            } catch (e) {
                console.error("Error creating room:", e);
                showMessage("ルームの作成に失敗しました。", "エラー");
            }
        };

        const joinRoom = async (roomId) => {
            const userProfile = (await getDoc(userDocRef)).data();
            if (!userProfile || !userProfile.username) {
                showMessage("ルームに参加するにはユーザー名が必要です。", "エラー");
                return;
            }
            roomDocRef = doc(db, `artifacts/${appId}/public/data/rooms`, roomId);
            try {
                await runTransaction(db, async (transaction) => {
                    const roomDoc = await transaction.get(roomDocRef);
                    if (!roomDoc.exists()) {
                        throw "Room does not exist!";
                    }
                    const roomData = roomDoc.data();
                    if (roomData.state !== 'waiting') {
                        throw "このルームはすでにゲームが始まっています。";
                    }
                    if (roomData.players.length >= 4) {
                        throw "このルームは満員です。";
                    }
                    if (roomData.players.some(p => p.userId === userId)) {
                        throw "すでにこのルームに参加しています。";
                    }

                    const newPlayers = arrayUnion({
                        userId: userId,
                        username: userProfile.username,
                        score: 0,
                        isFinished: false
                    });
                    transaction.update(roomDocRef, { players: newPlayers });
                });
                
                showRoomLobby();
                listenToRoom(roomId);

            } catch (e) {
                console.error("Error joining room:", e);
                showMessage(`ルーム参加に失敗しました: ${e}`, "エラー");
            }
        };
        
        const listenToRoom = (roomId) => {
            if (unsubscribeRoom) unsubscribeRoom();
            unsubscribeRoom = onSnapshot(doc(db, `artifacts/${appId}/public/data/rooms`, roomId), (docSnap) => {
                const roomData = docSnap.data();
                if (!roomData) return;
                
                document.getElementById('lobby-room-id').innerText = `ルームID: ${roomId}`;
                
                const playerListHtml = roomData.players.map(p => `
                    <li class="p-2 border-b border-gray-200">${p.username}</li>
                `).join('');
                document.getElementById('lobby-player-list').innerHTML = playerListHtml;
                
                // Show Start button only for the host
                if (roomData.hostId === userId && roomData.players.length >= 2) {
                    document.getElementById('start-game-btn').classList.remove('hidden');
                } else {
                    document.getElementById('start-game-btn').classList.add('hidden');
                }

                // Game start signal
                if (roomData.state === 'in-game') {
                    startGame('online', 'normal', roomId);
                }
            });
        };
        
        const startOnlineGame = async () => {
            if (!roomDocRef) return;
            try {
                const { number } = generateNumber('normal');
                await updateDoc(roomDocRef, { state: 'in-game', questionNumber: number, startedAt: serverTimestamp() });
            } catch (e) {
                console.error("Error starting game:", e);
                showMessage("ゲームの開始に失敗しました。", "エラー");
            }
        };

        const leaveRoom = () => {
             if (unsubscribeRoom) {
                unsubscribeRoom();
                unsubscribeRoom = null;
            }
            if (roomDocRef) {
                // Remove player from the room or delete room if host
                // This logic is simplified for the example
                showMainScreen();
            }
        };

        const findRandomRoom = async () => {
            const roomsCol = collection(db, `artifacts/${appId}/public/data/rooms`);
            const q = query(roomsCol, where('state', '==', 'waiting'));
            const querySnapshot = await getDocs(q);
            
            if (!querySnapshot.empty) {
                const room = querySnapshot.docs[0];
                joinRoom(room.id);
            } else {
                showMessage("参加可能なルームが見つかりませんでした。新しいルームを作成します。", "お知らせ");
                createRoom();
            }
        };


        // Event Listeners
        window.onload = setupFirebase;
        document.getElementById('set-username-btn').onclick = () => {
            const username = document.getElementById('username-input').value.trim();
            setUsername(username);
        };
        document.getElementById('play-offline-btn').onclick = () => startGame('offline', 'normal');
        document.getElementById('play-online-btn').onclick = showOnlineMenu;
        document.getElementById('random-match-btn').onclick = findRandomRoom;
        document.getElementById('create-room-btn').onclick = createRoom;
        document.getElementById('join-room-btn').onclick = () => {
            const roomId = document.getElementById('join-room-input').value.trim().toUpperCase();
            if (roomId) joinRoom(roomId);
            else showMessage("ルームIDを入力してください。", "エラー");
        };
        document.getElementById('start-game-btn').onclick = startOnlineGame;
        document.getElementById('leave-room-btn').onclick = leaveRoom;
        document.getElementById('submit-answer-btn').onclick = submitAnswer;
        document.getElementById('answer-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                submitAnswer();
            }
        });
        document.getElementById('back-to-menu-btn').onclick = showMainScreen;
    </script>
    
    <!-- Message Container -->
    <div id="message-container" class="hidden"></div>

    <!-- Main Card Container -->
    <div class="card">
        <!-- Loading Screen -->
        <div id="loading-screen" class="screen">
            <h2 class="text-2xl font-bold mb-4">ロード中...</h2>
            <p>ゲームの準備をしています...</p>
        </div>

        <!-- Username Input Screen -->
        <div id="name-input-screen" class="screen hidden">
            <h2 class="text-2xl font-bold mb-4">ユーザー名を入力してください</h2>
            <input id="username-input" type="text" placeholder="あなたのユーザー名" class="input-box mb-4">
            <button id="set-username-btn" class="btn w-full">決定</button>
        </div>

        <!-- Main Menu Screen -->
        <div id="main-menu-screen" class="screen hidden">
            <div class="flex justify-between items-center mb-6">
                <p id="username-display" class="font-bold text-gray-700"></p>
                <p id="rating-display" class="font-bold text-gray-700"></p>
            </div>
            <h1 class="text-3xl font-bold mb-6">素因数分解早押し</h1>
            <div class="space-y-4">
                <button id="play-online-btn" class="btn w-full">オンラインでプレイ</button>
                <button id="play-offline-btn" class="btn w-full">オフラインでプレイ</button>
            </div>
        </div>
        
        <!-- Online Menu Screen -->
        <div id="online-menu-screen" class="screen hidden">
            <h2 class="text-2xl font-bold mb-6">オンライン対戦</h2>
            <div class="space-y-4">
                <button id="random-match-btn" class="btn w-full">ランダムマッチ</button>
                <button id="create-room-btn" class="btn w-full">ルームを作成</button>
                <div class="flex space-x-2">
                    <input id="join-room-input" type="text" placeholder="ルームIDを入力" class="input-box flex-grow">
                    <button id="join-room-btn" class="btn">参加</button>
                </div>
                <button id="back-to-menu-btn" class="btn w-full bg-gray-400 hover:bg-gray-500">戻る</button>
            </div>
        </div>

        <!-- Room Lobby Screen -->
        <div id="room-lobby-screen" class="screen hidden">
            <h2 class="text-2xl font-bold mb-4">ルームロビー</h2>
            <p id="lobby-room-id" class="text-lg mb-4 font-bold"></p>
            <ul id="lobby-player-list" class="bg-gray-50 rounded-lg p-4 mb-4"></ul>
            <button id="start-game-btn" class="btn w-full mb-2 hidden">ゲーム開始</button>
            <button id="leave-room-btn" class="btn w-full bg-red-500 hover:bg-red-600">ルームを退出</button>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen hidden">
            <!-- Game Area -->
            <div id="game-area">
                <h2 class="text-xl font-bold mb-4">問題を素早く解こう！</h2>
                <div class="flex justify-center items-center mb-4">
                    <span class="text-4xl font-extrabold text-indigo-600" id="question-number"></span>
                </div>
                <input type="text" id="answer-input" placeholder="例: 2*3*5" class="input-box mb-4 text-center">
                <button id="submit-answer-btn" class="btn w-full">回答</button>
                <div class="timer-bar mt-4">
                    <div id="timer-fill" class="timer-fill"></div>
                </div>
                <p id="result-message" class="mt-4 text-lg font-semibold"></p>
            </div>
            <!-- Leaderboard Area -->
            <div id="leaderboard-area" class="hidden">
                 <h2 class="text-2xl font-bold mb-4">最終結果</h2>
                 <p id="final-message" class="text-lg font-semibold mb-4"></p>
                 <ul id="leaderboard-list" class="space-y-2 text-left"></ul>
                 <button id="back-to-menu-btn" class="btn w-full mt-4 bg-gray-400 hover:bg-gray-500">メニューに戻る</button>
            </div>
        </div>
    </div>
</body>
</html>
