<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>素因数分解早押し（Firestore）</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN",sans-serif;margin:0;padding:0;background:#f7f7fb;color:#111}
  header{padding:12px;background:#2b2f6b;color:#fff}
  main{padding:16px;max-width:980px;margin:18px auto}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .card{background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.06);min-width:240px}
  button{padding:8px 12px;border-radius:6px;border:0;background:#2b2f6b;color:#fff;cursor:pointer}
  input,select{padding:8px;border-radius:6px;border:1px solid #ddd}
  #playersList li{margin-bottom:6px}
  #buzzer{font-size:20px;padding:14px 18px;background:#c62828}
  .muted{color:#666;font-size:.9rem}
  .center{text-align:center}
  .big{font-size:28px;font-weight:700}
  .small{font-size:.85rem;color:#555}
</style>
</head>
<body>
<header>
  <div style="max-width:980px;margin:0 auto;display:flex;justify-content:space-between;align-items:center">
    <div>素因数分解早押し（オンライン & オフライン）</div>
    <div id="uidDisplay" class="small">サインイン中...</div>
  </div>
</header>
<main>
  <div class="row">
    <!-- 控えめな左カラム：マッチング -->
    <div class="card" style="flex:1 1 320px">
      <h3>マッチング / ルーム</h3>
      <div class="small muted">匿名で参加します。ニックネームを入力してください。</div>
      <div style="margin-top:8px">
        <input id="nameInput" placeholder="表示名 (例: taro)" />
        <button id="saveNameBtn">保存</button>
      </div>

      <hr />

      <div>
        <button id="createRoomBtn">ルームを作成</button>
        <label style="margin-left:8px">最大人数
          <select id="roomSize">
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4" selected>4</option>
          </select>
        </label>
      </div>

      <div style="margin-top:8px">
        <button id="randomMatchBtn">ランダムマッチ</button>
      </div>

      <div style="margin-top:12px">
        <label>自分の名前: <span id="myName">未設定</span></label><br/>
        <label>レート: <span id="myRating">--</span></label>
      </div>
    </div>

    <!-- 右カラム：ゲーム / 進行 -->
    <div class="card" style="flex:2 1 520px">
      <h3>現在のルーム / ゲーム</h3>
      <div id="roomArea" class="muted">ルームに参加するとここに表示されます。</div>

      <ul id="playersList"></ul>

      <div id="hostControls" style="margin-top:8px;display:none">
        <button id="startGameBtn">ゲーム開始（ホスト）</button>
      </div>

      <hr />

      <div id="gameArea" style="display:none">
        <div class="center">
          <div id="numberToFactor" class="big">--</div>
          <div class="small muted">この数の素因数をできるだけ早く入力して下さい（完全な分解）</div>
        </div>

        <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
          <button id="buzzer">早押し！</button>
          <input id="answerInput" placeholder="例: 2×2×3" style="flex:1" />
          <button id="submitAnswerBtn">提出</button>
          <div id="timer" class="small muted">00:00</div>
        </div>

        <div style="margin-top:8px">
          <div>得点: <span id="scoreBoard">---</span></div>
          <div id="lastResult" class="small"></div>
        </div>
      </div>
    </div>

    <!-- 右下：オフライン練習 -->
    <div class="card" style="flex:1 1 320px">
      <h3>オフライン（1人プレイ）</h3>
      <div class="small muted">練習モード。制限時間・問題数を設定して開始。</div>
      <div style="margin-top:8px">
        <label>問題数 <input id="practiceCount" type="number" value="10" style="width:70px" /></label><br/>
        <label>最大値（生成する整数の上限） <input id="practiceMax" type="number" value="1000" style="width:90px" /></label><br/>
        <button id="startPracticeBtn" style="margin-top:8px">練習開始</button>
      </div>

      <div id="practiceArea" style="margin-top:12px;display:none">
        <div class="big" id="practiceNum">--</div>
        <input id="practiceAns" placeholder="素因数を入力 (例:2*2*3)" />
        <button id="practiceSubmit">チェック</button>
        <div id="practiceResult" class="small muted"></div>
        <div>得点: <span id="practiceScore">0</span></div>
      </div>
    </div>
  </div>

  <hr />

  <div class="card">
    <h3>メモ / 注意</h3>
    <ul>
      <li class="small">ブラウザは最新のChrome/Edge/Firefox/Safari推奨。スマホでも動きます。</li>
      <li class="small">Firestore にルームとユーザー情報を保存します。プロジェクトの課金設定に注意。</li>
    </ul>
  </div>
</main>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* ============================
   Firebase 初期化
   （ユーザー提供の config を使用）
   ============================ */
const firebaseConfig = {
  apiKey: "AIzaSyDlBrmFABOpYPBNAeCFE141ru548lhPYjI",
  authDomain: "seat-change-optimization.firebaseapp.com",
  databaseURL: "https://seat-change-optimization-default-rtdb.firebaseio.com",
  projectId: "seat-change-optimization",
  storageBucket: "seat-change-optimization.firebasestorage.app",
  messagingSenderId: "416064751674",
  appId: "1:416064751674:web:948214f3bf9680062ccd03",
  measurementId: "G-H60QZSMLD1"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ============================
   グローバル変数（クライアント側）
   ============================ */
let myUid = null;
let myName = localStorage.getItem('pf_name') || '';
let myRating = Number(localStorage.getItem('pf_rating')) || 1200;
let currentRoomId = null;
let isHost = false;
let roomUnsub = null;
let gameUnsub = null;
let buzzerLocked = false;
let localScores = {}; // ui用
const K = 32; // Elo K-factor

/* ============================
   Helpers
   ============================ */
function randomInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function nowTs(){ return Date.now(); }
function show(el,tf){ el.style.display = tf ? '' : 'none'; }
function parseFactorsInput(s){
  // 2*2*3 か 2×2×3 か "2 2 3" などを受け取る -> sorted array of primes
  if(!s) return null;
  s = s.replace(/×/g,'*').replace(/×/g,'*').replace(/x/g,'*');
  s = s.replace(/\s+/g,'');
  // allow commas
  s = s.replace(/,/g,'*');
  const parts = s.split('*').filter(Boolean);
  if(parts.length===0) return null;
  const nums = parts.map(p=>Number(p)).filter(n=>Number.isInteger(n) && n>1);
  if(nums.length!==parts.length) return null;
  nums.sort((a,b)=>a-b);
  return nums;
}
function factorize(n){
  // 素因数分解を返す（配列）
  const res=[];
  let x=n;
  for(let p=2;p*p<=x;p++){
    while(x%p===0){ res.push(p); x/=p; }
  }
  if(x>1) res.push(x);
  return res;
}
function factorsEqual(a,b){
  if(!a||!b) return false;
  if(a.length!==b.length) return false;
  for(let i=0;i<a.length;i++) if(a[i]!==b[i]) return false;
  return true;
}
function updateMyUI(){
  document.getElementById('myName').innerText = myName||'（未設定）';
  document.getElementById('myRating').innerText = myRating;
  document.getElementById('uidDisplay').innerText = 'ID: ' + (myUid||'...');
}
function genNumberForRoom(roomDoc){
  // roomDoc の難易度に合わせて生成（簡単）
  // 2〜10個の素因数でランダムな数を作る or 単純にランダム整数
  const max = roomDoc && roomDoc.maxValue ? roomDoc.maxValue : 2000;
  const n = randomInt(2, max);
  return n;
}

/* ============================
   Auth：匿名ログイン
   ============================ */
auth.onAuthStateChanged(async user=>{
  if(user){
    myUid = user.uid;
    // ユーザードキュメント取得 or 作成
    const uref = db.collection('users').doc(myUid);
    const snap = await uref.get();
    if(!snap.exists){
      await uref.set({name: myName || ('Player'+myUid.slice(-4)), rating: myRating});
    } else {
      const d = snap.data();
      if(d.name) myName = d.name;
      if(d.rating) myRating = d.rating;
    }
    updateMyUI();
  } else {
    try{ await auth.signInAnonymously(); }catch(e){ alert('Auth error: '+e.message); }
  }
});

/* ============================
   UI イベント
   ============================ */
document.getElementById('saveNameBtn').onclick = async ()=>{
  const v = document.getElementById('nameInput').value.trim();
  if(!v){ alert('名前を入力してください'); return; }
  myName = v;
  localStorage.setItem('pf_name', myName);
  updateMyUI();
  if(myUid){
    await db.collection('users').doc(myUid).set({name: myName, rating: myRating}, {merge:true});
  }
};

document.getElementById('createRoomBtn').onclick = async ()=>{
  if(!myUid){ alert('認証中です。少し待ってください。'); return; }
  const cap = Number(document.getElementById('roomSize').value);
  const roomRef = await db.collection('rooms').add({
    host: myUid,
    hostName: myName,
    capacity: cap,
    players: [{uid: myUid, name: myName, rating: myRating}],
    state: 'waiting',
    createdAt: nowTs(),
    currentNumber: genNumberForRoom({maxValue:2000}),
    scores: {[myUid]:0}
  });
  joinRoom(roomRef.id);
};

document.getElementById('randomMatchBtn').onclick = async ()=>{
  // 空いてるwaitingルームを探して参加、無ければ新規作成
  const cap = Number(document.getElementById('roomSize').value);
  const q = await db.collection('rooms')
    .where('state','==','waiting')
    .where('capacity','==',cap)
    .orderBy('createdAt')
    .limit(5)
    .get();
  let joined=false;
  for(const doc of q.docs){
    const r = doc.data();
    if((r.players||[]).length < r.capacity){
      // try to append atomically with transaction
      try{
        await db.runTransaction(async tx=>{
          const snap = await tx.get(doc.ref);
          const data = snap.data();
          if((data.players||[]).find(p=>p.uid===myUid)) { joined=true; return; }
          if((data.players||[]).length >= data.capacity) throw 'full';
          const newPlayers = (data.players||[]).concat([{uid:myUid, name:myName, rating:myRating}]);
          const newScores = Object.assign({}, data.scores || {});
          newScores[myUid] = 0;
          tx.update(doc.ref, {players: newPlayers, scores: newScores});
          joined=true;
        });
        if(joined){ joinRoom(doc.id); return; }
      }catch(e){ /* try next */ }
    }
  }
  // 参加できなければ作る
  const roomRef = await db.collection('rooms').add({
    host: myUid,
    hostName: myName,
    capacity: cap,
    players: [{uid: myUid, name: myName, rating: myRating}],
    state: 'waiting',
    createdAt: nowTs(),
    currentNumber: genNumberForRoom({maxValue:2000}),
    scores: {[myUid]:0}
  });
  joinRoom(roomRef.id);
};

document.getElementById('startGameBtn').onclick = async ()=>{
  if(!currentRoomId) return;
  const rref = db.collection('rooms').doc(currentRoomId);
  await rref.update({state:'playing', startedAt: nowTs()});
};

document.getElementById('buzzer').onclick = ()=>{
  if(!currentRoomId) return;
  if(buzzerLocked) return;
  buzzerLocked = true;
  // publish buzzer claim to room
  db.collection('rooms').doc(currentRoomId).update({lastBuzzer: {uid: myUid, name: myName, at: nowTs()}});
  document.getElementById('lastResult').innerText = '早押ししました。回答欄に入力して提出してください。';
};

document.getElementById('submitAnswerBtn').onclick = async ()=>{
  if(!currentRoomId) return;
  // only accept if lastBuzzer.uid === myUid (or host allow)
  const roomDoc = await db.collection('rooms').doc(currentRoomId).get();
  const r = roomDoc.data();
  const last = r.lastBuzzer || {};
  if(last.uid !== myUid){
    alert('早押ししていないか、既に別の人の回答が受け付けられています。');
    return;
  }
  const answerStr = document.getElementById('answerInput').value.trim();
  const parsed = parseFactorsInput(answerStr);
  if(!parsed){ alert('回答が読み取れません。例: 2*2*3'); buzzerLocked=false; return; }
  const correct = factorize(r.currentNumber);
  if(factorsEqual(parsed, correct)){
    // correct: add score and publish winner
    const rref = db.collection('rooms').doc(currentRoomId);
    await db.runTransaction(async tx=>{
      const snap = await tx.get(rref);
      const data = snap.data();
      const scores = Object.assign({}, data.scores || {});
      scores[myUid] = (scores[myUid] || 0) + 1;
      // next number
      const nextNum = genNumberForRoom(data);
      tx.update(rref, {scores, lastAnswer: {uid: myUid, name: myName, at: nowTs(), value: answerStr, correct:true}, currentNumber: nextNum});
    });
    document.getElementById('lastResult').innerText = '正解！ +1点';
    document.getElementById('answerInput').value = '';
  } else {
    // incorrect: penalty or reveal
    const rref = db.collection('rooms').doc(currentRoomId);
    await rref.update({lastAnswer: {uid: myUid, name: myName, at: nowTs(), value: answerStr, correct:false}});
    document.getElementById('lastResult').innerText = '不正解。次の人へ。';
  }
  buzzerLocked = false;
};

document.getElementById('startPracticeBtn').onclick = ()=>{
  const cnt = Number(document.getElementById('practiceCount').value) || 10;
  const maxv = Number(document.getElementById('practiceMax').value) || 1000;
  startPractice(cnt, maxv);
};
document.getElementById('practiceSubmit').onclick = ()=>{
  const ans = document.getElementById('practiceAns').value;
  checkPractice(ans);
};

/* ============================
   ルーム参加 / 監視
   ============================ */
async function joinRoom(roomId){
  leaveRoom();
  currentRoomId = roomId;
  document.getElementById('roomArea').innerText = 'ルーム: ' + roomId;
  // サブスクライブ
  const rref = db.collection('rooms').doc(roomId);
  roomUnsub = rref.onSnapshot(async snap=>{
    if(!snap.exists){ alert('ルームが消されました。'); leaveRoom(); return; }
    const data = snap.data();
    renderRoom(data, roomId);
  });
}
function leaveRoom(){
  if(roomUnsub){ roomUnsub(); roomUnsub=null; }
  currentRoomId = null;
  isHost = false;
  document.getElementById('roomArea').innerText = 'ルームに参加するとここに表示されます。';
  document.getElementById('playersList').innerHTML = '';
  if(gameUnsub){ gameUnsub(); gameUnsub=null; }
  show(document.getElementById('gameArea'), false);
  document.getElementById('hostControls').style.display='none';
}
function renderRoom(data, roomId){
  // players list
  const pl = data.players || [];
  const ul = document.getElementById('playersList');
  ul.innerHTML = '';
  for(const p of pl){
    const li = document.createElement('li');
    li.innerHTML = `${p.name} <span class="small muted">(${p.rating||1200})</span>`;
    ul.appendChild(li);
  }
  // host?
  isHost = (data.host === myUid);
  document.getElementById('hostControls').style.display = isHost && data.state === 'waiting' ? '' : 'none';

  // show game area if playing
  if(data.state === 'playing'){
    show(document.getElementById('gameArea'), true);
    document.getElementById('numberToFactor').innerText = data.currentNumber || '--';
    // scoreboard
    const scores = data.scores || {};
    const sb = Object.entries(scores).map(([uid,sc])=>{
      const p = (data.players||[]).find(x=>x.uid===uid);
      return (p?p.name:uid.slice(0,6)) + ':' + sc;
    }).join(' / ');
    document.getElementById('scoreBoard').innerText = sb;
    // last answer display
    const last = data.lastAnswer;
    if(last){
      document.getElementById('lastResult').innerText = `${last.name} の回答: ${last.value} => ${last.correct ? '正解' : '不正解'}`;
    }
    // if game ended? (not implemented advanced)
    // subscribe to game end events for Elo update: when someone leaves or host ends, or manual trigger
    // We'll listen for "ended" field
    if(data.ended && !data.eloUpdated){
      // finalize ratings
      finalizeRatings(roomId, data);
    }
  } else {
    show(document.getElementById('gameArea'), false);
  }
}

/* ============================
   レーティング更新（簡易 Elo, マルチプレイヤー対応）
   - winner: expected score vs each opponent, actual =1
   - losers: actual =0 vs each opponent
   ============================ */
async function finalizeRatings(roomId, data){
  if(!data || !data.players) return;
  const scores = data.scores || {};
  // determine winner by highest score
  let bestUid = null, bestScore = -Infinity;
  for(const p of data.players){
    const s = scores[p.uid] || 0;
    if(s > bestScore){ bestScore = s; bestUid = p.uid; }
  }
  // compute new ratings
  const players = data.players.map(p=>({uid:p.uid,name:p.name,rating:p.rating||1200,score:scores[p.uid]||0}));
  const updates = {}; // uid -> newRating
  for(const A of players){
    let RA = A.rating;
    let SA = (A.uid === bestUid) ? 1 : 0;
    // expected vs each opponent
    let EA=0;
    for(const B of players){
      if(B.uid===A.uid) continue;
      EA += 1/(1+Math.pow(10, (B.rating-RA)/400));
    }
    EA = EA / (players.length - 1); // normalize
    const newR = Math.round(RA + K*(SA - EA));
    updates[A.uid] = newR;
  }
  // write back to user docs and mark room eloUpdated
  const batch = db.batch();
  for(const uid in updates){
    const ref = db.collection('users').doc(uid);
    batch.set(ref, {rating: updates[uid]}, {merge:true});
  }
  const roomRef = db.collection('rooms').doc(roomId);
  batch.update(roomRef, {eloUpdated:true, finalRatings: updates});
  await batch.commit();
}

/* ============================
   練習モード（オフライン）
   ============================ */
let practiceState = null;
function startPractice(count, maxv){
  practiceState = {count, maxv, cur:0, score:0, curNumber:null};
  document.getElementById('practiceScore').innerText = '0';
  show(document.getElementById('practiceArea'), true);
  nextPractice();
}
function nextPractice(){
  if(!practiceState) return;
  if(practiceState.cur >= practiceState.count){
    document.getElementById('practiceResult').innerText = '終了！ 得点: ' + practiceState.score;
    practiceState = null;
    return;
  }
  practiceState.cur++;
  const n = randomInt(2, practiceState.maxv);
  practiceState.curNumber = n;
  document.getElementById('practiceNum').innerText = n;
  document.getElementById('practiceAns').value = '';
  document.getElementById('practiceResult').innerText = `問題 ${practiceState.cur}/${practiceState.count}`;
}
function checkPractice(ans){
  if(!practiceState) return;
  const parsed = parseFactorsInput(ans);
  if(!parsed){ document.getElementById('practiceResult').innerText = '入力が不正です。形式: 2*2*3'; return; }
  const correct = factorize(practiceState.curNumber);
  if(factorsEqual(parsed, correct)){
    practiceState.score++;
    document.getElementById('practiceResult').innerText = '正解！';
  } else {
    document.getElementById('practiceResult').innerText = '不正解。正解は: ' + correct.join('*');
  }
  document.getElementById('practiceScore').innerText = String(practiceState.score);
  setTimeout(nextPractice, 800);
}

/* ============================
   初期UI更新
   ============================ */
document.getElementById('answerInput').addEventListener('keydown', e=>{
  if(e.key==='Enter') document.getElementById('submitAnswerBtn').click();
});
updateMyUI();

</script>
</body>
</html>
